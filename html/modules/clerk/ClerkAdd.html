<script type="text/javascript">
       if(sessionStorage.getItem('securityContext')==null){
         window.location.href="../../../login.html";
        }
        var securityContext = JSON.parse(sessionStorage.getItem('securityContext'));

        var path = sessionStorage.getItem('path');
</script>
<!DOCTYPE html>
<html>
<head>
	<title>新建零售定价</title>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	<link type="text/css" rel="stylesheet" href="/APPLETPC/css/common/common.css">
    <link type="text/css" rel="stylesheet" href="/APPLETPC/js/bootstrap/css/bootstrap.css">
	<script type="text/javascript"src="/APPLETPC/js/jquery/jquery-2.2.3.min.js"></script>
	<script type="text/javascript" src="/APPLETPC/js/common/common.js"></script>
	<script type="text/javascript" src="/APPLETPC/js/common/util.js"></script>
    <script type="text/javascript" src="/APPLETPC/js/json/json2.js"></script>
    <script type="text/javascript" src="/APPLETPC/js/bootstrap/js/bootstrap.js"></script>
	<script type="text/javascript" src="/APPLETPC/js/json/model/AppClerk.js"></script>
	<script type="text/javascript" src="/APPLETPC/js/plugins/jquery-validate/jquery.validate.min.js"></script>
	<script type="text/javascript" src="/APPLETPC/js/plugins/jquery-validate/jquery.validate.plu.js"></script>
	<link rel="stylesheet" href="/APPLETPC/js/plugins/jquery-chosen/css/chosen.css" type="text/css"></link>
	<script type="text/javascript" src="/APPLETPC/js/plugins/jquery-chosen/js/chosen.jquery.js"></script>
	<script type="text/javascript" src="/APPLETPC/js/plugins/layer/layer.js"></script>
	<script type="text/javascript" src="../../../js/plugins/city-ganged/date.js"></script>
	
	<style>
.item {
	width: 160px;
	height: 250px;
	float: left;
	position: relative;
	margin: 20px;
}

.addImg {
	width: 160px;
	height: 250px;
	position: absolute;
	left: 55px;
	top: 0;
	z-index: 2;
	cursor: pointer;
}

.preview,.preBlock {
	position: absolute;
	display: none;
	width: 160px;
	height: 250px;
	left: 28px;
	top: 0;
}

.delete {
	width: 20px;
	position: absolute;
	right: -55px;
	top: 0px;
	cursor: pointer;
	display: none;
}

.preBlock img {
	display: block;
	width: 160px;
	height: 250px;
}

.upload_input {
	display: block;
	width: 0;
	height: 0;
	-webkit-opacity: 0.0;
	/* Netscape and Older than Firefox 0.9 */
	-moz-opacity: 0.0;
	/* Safari 1.x (pre WebKit!) 老式khtml内核的Safari浏览器*/
	-khtml-opacity: 0.0;
	/* IE9 + etc...modern browsers */
	opacity: .0;
	/* IE 4-9 */
	filter: alpha(opacity = 0);
	/*This works in IE 8 & 9 too*/
	-ms-filter: "progid:DXImageTransform.Microsoft.Alpha(Opacity=0)";
	/*IE4-IE9*/
	filter: progid:DXImageTransform.Microsoft.Alpha(Opacity=0 );
}
</style>
	</head>
	
	
	<body class="my-body-content">
<form id="ClerkAddForm" name="ClerkAddForm" class="my-form-content">
	
			 <div class="item">
		        <img class="addImg" onclick="clickImg(this);" src="/APPLETPC/js/plugins/app-imgupload/img/addImg.png" />
		        <input name="url" type="file" class="upload_input" onchange="change(this)"/>
		        <div class="preBlock">
		            <img class="preview" id="preview" alt="" name="pic" width="190" height="190" />
		        </div>
		        <img class="delete" onclick="deleteImg(this)" src="/APPLETPC/js/plugins/app-imgupload/img/delete.png"/>
		    </div>
				<table class="my-form-table-content">
					<tr>
						<td class="my-form-table-td-label">
							<label class="control-label" style="margin:5px;padding:0px;">所属门店</label>
						</td>
						<td class="my-form-table-td-content" style="width:200px;">
							<div class="input-group">
								<input type="hidden" id="store_code" name="store_code">
								<input type="text" id="store_name"   class="form-control input-sm"  name="store_name" class="form-control input-sm" style="width:145px;padding:5px;float:left;background-color:#fff; border-radius: 3px;" readOnly>
								<span class="input-group-btn" style="float: left">
		        					<button id="lovBtn" class="btn btn-default" type="button" style="padding:7px 10px;" onclick="openLovLov();">
		        						<i class="glyphicon glyphicon-search"></i>
		        					</button>
		      					</span>
						
						</td>
					</tr>
					<tr>
						<td class="my-form-table-td-label">
							<label class="control-label" style="margin:5px;padding:0px;" >量体师证号</label>
						</td>	
						<td class="my-form-table-td-content" style="width:200px;">
							<input  id="clerk_id" name="clerk_id" type="text"   class="form-control input-sm"  style="width:180px;padding:5px;float:left;"    >
						</td>
					</tr>
					<tr>
						<td class="my-form-table-td-label">
							<label class="control-label" style="margin:5px;padding:0px;" >名称</label>
						</td>	
						<td class="my-form-table-td-content" >
							<input  id="clerk_name" name="clerk_name" type="text"   class="form-control input-sm"  style="width:180px;padding:5px;float:left;"    >
						</td>
					</tr>
					<tr>
						<td class="my-form-table-td-label">
							<label class="control-label" style="margin:5px;padding:0px;" >电话</label>
						</td>	
						<td class="my-form-table-td-content">
							<input  id="clerk_tel" name="clerk_tel" type="text"   class="form-control input-sm"  style="width:180px;padding:5px;float:left;"    >
						</td>
					</tr>
					<tr>
						<td class="my-form-table-td-label">
							<label class="control-label" style="margin:5px;padding:0px;">性别</label>
						</td>
						<td class="my-form-table-td-content">
							<select id="clerk_sex" name="clerk_sex" class="dept_select dimension_coding"  style="width:180px;padding:5px;float:left;" >
							 <option value="男">男</option>
							 <option value="女">女</option>
							</select> 
						</td>
					</tr>
					
					<tr>
						<td class="my-form-table-td-label">
							<label class="control-label" style="margin:5px;padding:0px;">量体省</label>
						</td>
						<td class="my-form-table-td-content">
							<select id="MeasureProvince" name="MeasureProvince" class="dept_select dimension_coding"  style="width:180px;padding:5px;float:left;" >
							</select> 
						</td>
					</tr>
					<tr>
						<td class="my-form-table-td-label">
							<label class="control-label" style="margin:5px;padding:0px;">量体市</label>
						</td>
						<td class="my-form-table-td-content">
							<select id="MeasureCity" name="MeasureCity" class="dept_select dimension_coding"  style="width:180px;padding:5px;float:left;" >
							</select> 
						</td>
					</tr>
					<tr>
						<td class="my-form-table-td-label">
							<label class="control-label" style="margin:5px;padding:0px;">量体县</label>
						</td>
						<td class="my-form-table-td-content">
							<select id="MeasureCounty" name="MeasureCounty" class="dept_select dimension_coding"  style="width:180px;padding:5px;float:left;" >
							</select> 
						</td>
					</tr>
						<tr>
						<td class="my-form-table-td-label">
							<label class="control-label" style="margin:5px;padding:0px;" >微信号</label>
						</td>	
						<td class="my-form-table-td-content">
							<input  id="wx_number" name="wx_number" type="text"   class="form-control input-sm"  style="width:180px;padding:5px;float:left;"    >
						</td>
					</tr>
					<tr>
						<td class="my-form-table-td-label">
							<label class="control-label" style="margin:5px;padding:0px;" >个性签名</label>
						</td>	
						<td class="my-form-table-td-content">
							<textarea   id="instruction" name="instruction"   class="form-control input-sm"  rows="3"    style="width:180px;padding:5px;float:left;"    > </textarea > 
						</td>
					</tr>
				</table>
				
			</form>
</body>
</html>
<script type="text/javascript">
var validator;
$(document).ready(function() {
$("#clerk_sex").chosen({disable_search:true,width:"180px"});
$("#MeasureCity").chosen({disable_search_threshold:10,width:"180px"});
$("#MeasureProvince").chosen({disable_search_threshold:10,width:"180px"});
$("#MeasureCounty").chosen({disable_search:true,width:"180px"});
var measureCity = $('select[name="MeasureCity"]'),  measureProvince = $('select[name="MeasureProvince"]'), measureCounty = $('select[name="MeasureCounty"]');
        //加载省份下拉框选项
        for (var i in cities) {
            measureProvince.append('<option>' + i + '</option>');
        }
        //根据省份下拉框值，加载相应的城市下拉框选项，并定位地图中心点
        measureProvince.change(function () {
            var s = cities[this.value];
            measureCity.html('');
            for (var i in s) {
                measureCity.append('<option>' + i + '</option>');
            }
            measureCity.change();
            measureCity.trigger("chosen:updated")
        });
        measureCity.change(function () {
            var aa = (cities[measureProvince.val()])[this.value];
            measureCounty.html('');
            for (var i in aa) {
                    measureCounty.append('<option>' + aa[i] + '</option>');
                }
            measureCounty.trigger("chosen:updated")
        });
        measureProvince.change();
        measureProvince.trigger("chosen:updated")

validator = $("#ClerkAddForm").validate({
		debug: true,
		showErrors: showErrors,
		rules: {
			clerk_id: {
				required: true,
				maxlength: 12,
				isCode: true,
				remote: {
					url:path+"app/appClerk/checkClerkCode?t=" + new Date(),
					type: "get",
					data: {
						"store_code": function(){return $('#store_code').val()},
						"clerk_id": function(){return $('#clerk_id').val()},
						token: securityContext.token
					}
				}
			},
			store_code: {
				required: true
			},
			clerk_name:{
				maxlength: 30,
				required: true,
			},
			clerk_tel:{
				maxlength: 11,
				minlength: 11,
				number: true,
				required: true,
			},
			wx_number:{
				maxlength: 30,
			},
			instruction:{
				maxlength: 30,
			}
		},
		messages: {
			clerk_id: {
				required: "量体师编码不能为空！",
				maxlength: "量体师编码最大长度为12！",
				remote: "当前编码已存在"
			},
			store_code: {
				required: "门店编码不能为空"
			},
			clerk_name:{
				maxlength: "量体师名称最大长度为30！",
				required: "量体师名称不能为空",
			},
			clerk_tel:{
				maxlength: "请输入正确手机号！",
				minlength: "请输入正确手机号！",
				number: "请输入数字！",
				required: "量体师手机号不能为空",
			},
			wx_number:{
				maxlength: "微信号最大长度为30！",
			},
			instruction:{
				maxlength: "个性签名最大长度为30！",
			}
		}
	});
	
	
});

  
 //量体师新建
function doAddClerk(clerk_image) {
	var result = false;
		var ac = new AppClerk();
		dwr.util.getValues(ac);
		ac.clerk_city=$("#MeasureProvince").val()+" "+($("#MeasureCity").val()==null?"":$("#MeasureCity").val())+" "+($("#MeasureCounty").val()==null?"":$("#MeasureCounty").val());
		ac.clerk_image=clerk_image;
		var url = path+"app/appClerk/insertAppClerk";
		url += "?t=" + new Date();
		url+="&token="+securityContext.token;

		$.ajax({
			type: "POST",
		    url: url,
		    data: ac,
		    async: false,
		    success: function(data){
				
				if (data.code == "S") {
					result = true;
				} else {
					result = false;
					$.growl.warning({    title: "错误标题", message: data.data});
				}
		    }
		});
	return result;
} 

//上传图片
function  uploadImage(){
	var result = false;	
			if (validator.form()) {
		var url = path+"uploadingImages/clerk";
		url += "?t=" + new Date();

        var pic = new FormData();
        if($(".upload_input")[0].files[0]==null){
        $.growl.error({    title: "错误标题", message: "请上传头像"});
        return false;
        }
        if($(".upload_input")[0].files[0].size>300000){
        $.growl.error({    title: "错误标题", message: "图片不符合规范,为保证访问速度请图片大小在300K以下"});
        return false;
        }
   		 pic.append("pic", $(".upload_input")[0].files[0]);
        $.ajax({
            url: url,
            type: 'POST',
            cache: false,
            data: pic,
            processData: false,
            contentType: false,
            async: false,
            success: function (data) {
            	
				if (data.code == "S") {
					result = doAddClerk(data.data)
				} else {
					result = false;
				$.growl.error({    title: "错误标题", message: data.info});
				}
            }
        });
        }
return result;
}
 
 function openLovLov() {
	var url = "/APPLETPC/html/common/lov/lov.html";
	sessionStorage.setItem('lovCode', 'lov_store');//值列表的编码
	sessionStorage.setItem('lovType', 'single');//值列表选值数量(单个)
	sessionStorage.setItem('message', '门店');
	var lovLovFrame = '<iframe id="lovLovFrame" class="my-modal-iframe" width="100%" height="350px" src="' + url + '"></iframe>';
	window.top.bootbox.dialog({
		title: "门店列表",
		message: lovLovFrame,
		size: "middle",
		buttons: {
			saveType: {
	      		label: "确定",
	      		className: "btn-success",
	      		callback: function() {
	      			var result = window.top.document.getElementById("lovLovFrame").contentWindow.getLovData();
	      			if(result){
	      			$("#store_code").val(result.lov);//将获取到的门店ID写入隐藏框
	      			$("#store_name").val(result.lovText);//将获取到的门店名称写入文本框
	      			};
	      			return result;
	      		}
			},
			cancelType: {
	      		label: "取消",
	      		className: "btn-default",
	      		callback: function() {
     			return true;
	      		}
			}
		}
	});
}	
 //点击
  var clickImg = function(obj){
    $(obj).parent().find('.upload_input').click();
  }
  //删除
  var deleteImg = function(obj){
    $(obj).parent().find('input').val('');
    $(obj).parent().find('img.preview').attr("src","");
     $(obj).parent().find('img.preview').hide();
    //IE9以下
    $(obj).parent().find('img.preview').css("filter","");
    $(obj).hide();
    $(obj).parent().find('.addImg').show();
  }
  //选择图片
  function change(file) {
      //预览
      var pic = $(file).parent().find(".preview");
      //添加按钮
      var addImg = $(file).parent().find(".addImg");
      //删除按钮
      var deleteImg = $(file).parent().find(".delete");

      var ext=file.value.substring(file.value.lastIndexOf(".")+1).toLowerCase();
 	
       // gif在IE浏览器暂时无法显示
       if(ext!='png'&&ext!='jpg'&&ext!='jpeg'){
          if (ext != '') {
            alert("图片的格式必须为png或者jpg或者jpeg格式！"); 
          } 
           return;
       }
          html5Reader(file,pic,addImg,deleteImg);
  }
 //H5渲染
  function html5Reader(file,pic,addImg,deleteImg){
     var file = file.files[0];
     var reader = new FileReader();
     reader.readAsDataURL(file);
     reader.onload = function(e){
         pic.attr("src",this.result);
     }
     addImg.hide();
     deleteImg.show();
     pic.show();
     pic.parent().show();
    
  }  
</script>