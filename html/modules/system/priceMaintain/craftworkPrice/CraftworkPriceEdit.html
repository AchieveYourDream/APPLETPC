<script type="text/javascript">
	if (sessionStorage.getItem('securityContext') == null) {
		window.location.href = "/APPLETPC/login.html";
	}
	var securityContext = JSON.parse(sessionStorage.getItem('securityContext'));
	var bootstrapSkin = securityContext.bootstrapSkin;
	var path = sessionStorage.getItem('path');
	var currentCraftworkPriceId = sessionStorage.getItem('currentCraftworkPriceId');
</script>
<!DOCTYPE html>
<html>
<head>
	<title>编辑零售定价信息</title>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	<link type="text/css" rel="stylesheet" href="/APPLETPC/css/common/common.css">
	<script type="text/javascript" src="/APPLETPC/js/common/common.js"></script>
	<script type="text/javascript" src="/APPLETPC/js/common/util.js"></script>
	<script type="text/javascript" src="/APPLETPC/js/jquery/jquery-2.2.3.min.js"></script>
	<script type="text/javascript" src="/APPLETPC/js/json/json2.js"></script>
	<link type="text/css" rel="stylesheet" href="/APPLETPC/js/bootstrap/css/bootstrap.css">
	<script type="text/javascript" src="/APPLETPC/js/bootstrap/js/bootstrap.js"></script>
	<script type="text/javascript" src="../../../../../js/json/model/SysCraftworkPrice.js"></script>
	<script type='text/javascript' src='/APPLETPC/js/json/model/SysLog.js'></script>
	<script type="text/javascript" src="/APPLETPC/js/plugins/jquery-validate/jquery.validate.min.js"></script>
	<script type="text/javascript" src="/APPLETPC/js/plugins/jquery-validate/jquery.validate.plu.js"></script>
	<link type="text/css" rel="stylesheet" href="/APPLETPC/js/plugins/bootstrap-datetime/css/bootstrap-datetimepicker.min.css">
	<script type="text/javascript" src="/APPLETPC/js/plugins/bootstrap-datetime/js/bootstrap-datetimepicker.min.js"></script>
	<script type="text/javascript" src="/APPLETPC/js/plugins/bootstrap-datetime/js/locales/bootstrap-datetimepicker.zh-CN.js"></script>
	<link rel="stylesheet" href="../../../../../js/plugins/jquery-chosen/css/chosen.css" type="text/css"></link>
	<script type="text/javascript" src="../../../../../js/plugins/jquery-chosen/js/chosen.jquery.js"></script>
	<script type="text/javascript" src="../../../../../js/plugins/layer/layer.js"></script>
	
	
	
</head>
<body class="my-body-content">
	<form id="typeAddForm" name="typeAddForm" class="my-form-content">
		<input readonly id="id" name=""id"" type="hidden" >
	
		<table class="my-form-table-content">
			<tr>
						<td class="my-form-table-td-label">
							<label class="control-label" style="margin:5px;padding:0px;">定价规范</label>
						</td>
						<td class="my-form-table-td-content" style="width:100px">
							<select id="price_specification" name="price_specification" class="dept_select dimension_coding" style="width:180px;padding:5px;float:left;"></select> 
						</td>
					</tr>
					<tr>
						<td class="my-form-table-td-label">
							<label class="control-label" style="margin:5px;padding:0px;">品类</label>
						</td>
						<td class="my-form-table-td-content">
							<select id="category" name="category" class="dept_select dimension_coding"  style="width:180px;padding:5px;float:left;" onchange="initTechnologyList()"></select> 
							
						</td>
					</tr>
					<tr>
						<td class="my-form-table-td-label">
							<label class="control-label" style="margin:5px;padding:0px;" >衬工艺</label>
						</td>
						<td class="my-form-table-td-content">
							<select id="shirt_technics" name="shirt_technics" class="dept_select dimension_coding" style="width:180px;padding:5px;float:left;"></select> 
						</td>
					</tr>
					<tr>
						<td class="my-form-table-td-label">
							<label class="control-label" style="margin:5px;padding:0px;">面料价格区间</label>
						</td>
						<td class="my-form-table-td-content" style="width:180px;padding:0px;float:left;">
							<nobr>
								<input id="fabric_price_range" name="fabric_price_range"  type="text"  onkeyup="totalPracticalPrice(this)"   min="0" required="required"   min="0"  class="form-control input-sm" style="width:80px;padding:5px;float:left;margin-right: 2px;">
								<span>—</span>
								<input id="fabric_price_range2" name="fabric_price_range2"   type="text"  onkeyup="totalPracticalPrice(this)"  min="0" required="required"    min="0" class="form-control input-sm" style="width:80px;padding:5px;float:right;">
							</nobr>
						</td>
					</tr>
					<tr>
						<td class="my-form-table-td-label">
							<label class="control-label" style="margin:5px;padding:0px;">是否默认衬工艺</label>
						</td>
						<td class="my-form-table-td-content">
							<select id="is_def_shirt_technics" name="is_def_shirt_technics" class="dept_select dimension_coding" style="width:180px;padding:5px;float:left;"></select> 
						</td>
					</tr>
					<tr id="tz1" style="display: none">
						<td class="my-form-table-td-label">
							<label class="control-label" style="margin:5px;padding:0px;" >西服零售价</label>
						</td>	
						<td class="my-form-table-td-content">
							<input  id="attribute1" name="attribute1" type="text"  onkeyup="totalPracticalPrice(this)" class="form-control input-sm"  style="width:180px;padding:5px;float:left;"   min="0" required="required"> </select> 
						</td>
					</tr>
					<tr id="tz2" style="display: none">
						<td class="my-form-table-td-label">
							<label class="control-label" style="margin:5px;padding:0px;" >西裤零售价</label>
						</td>	
						<td class="my-form-table-td-content">
							<input  id="attribute2" name="attribute2" type="text"  onkeyup="totalPracticalPrice(this)" class="form-control input-sm"  style="width:180px;padding:5px;float:left;"   min="0" required="required"> </select> 
						</td>
					</tr>
					<tr id="tz3" style="display: none">
						<td class="my-form-table-td-label">
							<label class="control-label" style="margin:5px;padding:0px;" >马甲零售价</label>
						</td>	
						<td class="my-form-table-td-content">
							<input  id="attribute3" name="attribute3" type="text"  onkeyup="totalPracticalPrice(this)" class="form-control input-sm"  style="width:180px;padding:5px;float:left;"   min="0" required="required"> </select> 
						</td>
					</tr>
					<tr>
						<td class="my-form-table-td-label">
							<label class="control-label" style="margin:5px;padding:0px;" >零售价</label>
						</td>	
						<td class="my-form-table-td-content">
							<input  id="retail_price" name="retail_price" type="text"  onkeyup="totalPracticalPrice(this)"  min="0" required="required" class="form-control input-sm"  style="width:180px;padding:5px;float:left;"></select> 
						</td>
					</tr>
		</table>
	</form>
</body>
</html>

<script type="text/javascript">
	var currentNodeId;
	var validator;
	var CraftworkPriceDate="";
	$(document).ready(function() {
		selectStoInformationByPk();	//根据id初始化表单
	});

	// 依据id获取零售定价列表
	function selectStoInformationByPk() {
		var url = path + "api/sys/price/getCraftworkPriceById";
		url += "?currentTime=" + new Date();
		$.ajax({
			type : "get",
			url : url,
			data:{"token":securityContext.token,"id":currentCraftworkPriceId},
			success : function(data) {
				if (data.result_code == "Y") {
					recordLog("O","APPLETPC","获取工艺价格列表成功",securityContext.user_id);
					var CraftworkPrice = JSON.parse(data.result_info);
					CraftworkPriceDate=CraftworkPrice;
					initCategoryList();						//初始化品类 下拉选
					initPriceSpecificationList();			//初始化定价规范 下拉选
					initTypeList();							//初始化是否默认衬工艺  下拉选
					dwr.util.setValues(CraftworkPrice);
				} else if (data.result_code == "N") {
				recordLog("OF","APPLETPC","获取工艺价格列表失败",securityContext.user_id);
					window.top.bootbox.dialog({
						title : "错误信息",
						message : "数据加载失败！" + "<br><br>" + data.result_info,
						size : "middle",
						buttons : {
							cancelType : {
								label : "确定",
								className : "btn-" + bootstrapSkin,
								callback : function() {
									return true;
								}
							}
						}
					});
				}
			}
		});
	}


	function initEdit(){
		var result = false;
		var addFalg = true;
		if(!$("#fabric_price_range")[0].validity.valid){
			layer.msg("【面料价格区间】不能为空")
			  $("#fabric_price_range").focus();
			return false;
		}else if(!$("#fabric_price_range2")[0].validity.valid){
			layer.msg("【面料价格区间】不能为空")
	 		$("#fabric_price_range2").focus();
			return false;
		}else if(!$("#retail_price")[0].validity.valid){
			layer.msg("【零售价】不能为空")
			$("#retail_price").focus();
			return false;
		}else if(parseFloat($("#fabric_price_range2")[0].value) <= parseFloat($("#fabric_price_range")[0].value)){
			layer.msg("【面料价格区间】格式错误")
			$("#fabric_price_range2").focus();
			return false;
		}else if(!$("#attribute1")[0].validity.valid){
			layer.msg("【西服零售价】不能为空")
			$("#attribute1").focus();
			return false;
		}else if(!$("#attribute2")[0].validity.valid){
			layer.msg("【西裤零售价】不能为空")
			$("#attribute2").focus();
			return false;
		}else if(!$("#attribute3")[0].validity.valid){
			layer.msg("【马甲零售价】不能为空")
			$("#attribute3").focus();
			return false;
		}else if($("#category")[0].value=='1' || $("#category")[0].value =='7'){
			if(parseFloat($("#attribute1")[0].value)+parseFloat($("#attribute2")[0].value) !=parseFloat($("#retail_price")[0].value)){
				layer.msg("【零售价错误】西服价格+西裤价格")
				$("#retail_price").focus();
				return false;
			}
		}else if($("#category")[0].value=='2' ){
			if(parseFloat($("#attribute1")[0].value)+parseFloat($("#attribute2")[0].value)+parseFloat($("#attribute3")[0].value) !=$("#retail_price")[0].value ){
				layer.msg("【零售价错误】西服价格+西裤价格+马甲价格")
				$("#retail_price").focus();
				return false;
				}
			}
		var cc = new SysCraftworkPrice();
		dwr.util.getValues(cc);
		var ccid=cc.id;
		var addFalg=false;
		var queryIsDefaultUrl = path+"api/sys/price/getListPrice";
		if(cc.is_def_shirt_technics == "yes"){
			 $.ajax({
					type : "get",
					url : queryIsDefaultUrl,
					async:false,
					data:{"token":securityContext.token,"price_specification":cc.price_specification,"category":cc.category,"shirt_technics":cc.shirt_technics,"fabric_price_range":cc.fabric_price_range,"fabric_price_range2":cc.fabric_price_range2,"id":cc.id},
					success : function(data) {
						if (data.result_info== "") {
							addFalg=true;
						}else{
							addFalg=false;
							layer.msg("此价格区间已有默认衬工艺项")
							$("#fabric_price_range2").focus();
						}
					}
				}); 
		}else{
			addFalg=true;
		}
		
		if(addFalg){
			result=doEditCraftworkPrice();
		}else{
			return false;
		}
		return result;
	
	}

	//编辑
	function doEditCraftworkPrice() {
			if(!$("#fabric_price_range")[0].validity.valid){
				layer.msg("【面料价格区间】不能为空")
				  $("#fabric_price_range").focus();
				return false;
			}else if(!$("#fabric_price_range2")[0].validity.valid){
				layer.msg("【面料价格区间】不能为空")
		 		$("#fabric_price_range2").focus();
				return false;
			}else if(!$("#retail_price")[0].validity.valid){
				layer.msg("【零售价】不能为空")
				$("#retail_price").focus();
				return false;
			}
			var result = false ;
			var cc = new SysCraftworkPrice();
			dwr.util.getValues(cc);
			cc.last_updated_by=securityContext.user_id;
			var url = path+"api/sys/price/update";
			url += "?t=" + new Date();
			url+="&token="+securityContext.token;
			$.ajax({
				type:"POST",
				url:url,
				contentType: 'application/json',
			 	data:JSON.stringify(cc),
				async:false,
				success: function(data) {
						if (data.result_code == "Y") {
							recordLog("O","APPLETPC","零售定价编辑成功",securityContext.user_id);
						 	result = true;
							window.top.bootbox.dialog({
								title: "提示信息",
								message: "保存成功！",
								size: "middle",
								buttons: {
									cancelType: {
							      		label: "确定",
							      		className: "btn-success",
							      		callback: function() {
							      			return true;
							      		}
									}
								}
							});
		        
						} else if (data.result_code == "N") {
							recordLog("OF","APPLETPC","零售定价编辑失败",securityContext.user_id);
							result = false;
							window.top.bootbox.dialog({
								title: "错误信息",
								message: "保存失败！" + "<br><br>" + json.result_info,
								size: "middle",
								buttons: {
									cancelType: {
							      		label: "确定",
							      		className: "btn-success",
							      		callback: function() {
							      			return true;
							      		}
									}
								}
							});
						}
				    }
				});
			return result;
	}
	
		
	//1 初始化定价规范
	function initPriceSpecificationList() {
		var url = path + "api/sys/price/getPriceSpecification";
		$.ajax({
			type : "get",
			url : url,
			headers:{"token":securityContext.token},
			success : function(data) {
				if (data.result_code == "Y") {
					$("#price_specification").html("");
					$("#price_specification").chosen("destroy"); 
					$.each(JSON.parse(data.result_info), function(index, d) {
	                   	var option='<option value="' + d.code + '">'+ d.name + '</option>';
	                   	category+=option
						$("#price_specification").append(option);  
					});
					$("#price_specification").chosen();
					
					$("#price_specification").val(CraftworkPriceDate.price_specification)//设置值  
					$("#price_specification").trigger('chosen:updated');//更新选项  
				} else if (data.result_code == "N") {
					window.parent.bootbox.dialog({
						title : "错误信息",
						message : "数据加载失败！" + "<br><br>" + data.result_info,
						size : "middle",
						buttons : {
							cancelType : {
								label : "确定",
								className : "btn-default",
								callback : function() {
									return true;
								}
							}
						}
					});
				}
			}
		});
	};	
	
	
	//2 初始化 品类
	function initCategoryList() {
		var url = path + "api/marketing/getCategorySelect";
		$.ajax({
			type : "POST",
			url : url,
			headers:{"token":securityContext.token},
			success : function(data) {
				if (data.result_code == "Y") {
					$("#category").html("");
					$.each(JSON.parse(data.result_info), function(index, d) {
	                  	var option='<option value="' + d.code + '">'+ d.name + '</option>';
	                    category+=option
						$("#category").append(option);  
					});
					$('#category').chosen();
					$("#category").val(CraftworkPriceDate.category)//设置值  
					$("#category").trigger('chosen:updated');//更新选项  
					$("#shirt_technics").chosen({placeholder_text_single:'该品类无衬工艺项'});
					initTechnologyList();//初始衬工艺 下拉选
					
				} else if (data.result_code == "N") {
					window.parent.bootbox.dialog({
						title : "错误信息",
						message : "数据加载失败！" + "<br><br>" + data.result_info,
						size : "middle",
						buttons : {
							cancelType : {
								label : "确定",
								className : "btn-default",
								callback : function() {
									return true;
								}
							}
						}
					});
				}
			}
		});
	};
	
	
	
	// 初始衬工艺 下拉选
	function initTechnologyList() {
		var url = path + "api/collectMoney/getTechnologySelect";
		$.ajax({
			type : "POST",
			url : url,
			data:{"token":securityContext.token,code:$("#category").val()},
			success : function(data) {
				if (data.result_code == "Y") {
						var tempData=JSON.parse(data.result_info);
						if($("#category").val()=='3000' || $("#category").val()=='11000'){
							tempData.push({code: "", name: "机器工艺"});
						}
						//显示西服西裤马甲的价格
						if($("#category").val()=='1' || $("#category").val()=='7'){
							$("#tz3")[0].style.display="none";
							$("#attribute3")[0].value="";
							$("#attribute3")[0].required=false
							$("#attribute1")[0].required=true
							$("#attribute2")[0].required=true
							$("#tz1")[0].style.display="";
							$("#tz2")[0].style.display="";
						}else if($("#category").val()=='2' ){
							$("#tz1")[0].style.display="";
							$("#tz2")[0].style.display="";
							$("#tz3")[0].style.display="";
							$("#attribute1")[0].required=true
							$("#attribute2")[0].required=true
							$("#attribute3")[0].required=true
						}else{
							$("#tz1")[0].style.display="none";
							$("#tz2")[0].style.display="none";
							$("#tz3")[0].style.display="none";
							$("#attribute1")[0].value="";
							$("#attribute2")[0].value="";
							$("#attribute3")[0].value="";
							$("#attribute1")[0].required=false
							$("#attribute2")[0].required=false
							$("#attribute3")[0].required=false
						}
						
						var falg = false;	//设置一个开关，判断 数据字典 和 当前数据库存值 是够一样，一样则设为下拉选默认值
						$("#shirt_technics").html("")
						$.each(tempData, function(index, d) {
		                   	var option='<option value="' + d.code + '">'+ d.name + '</option>';
		                   	$("#shirt_technics").append(option); 
		                   	if(d.code == CraftworkPriceDate.shirt_technics){
		                   		falg = true;
		                   	}
						});
						// 数据字典 和 当前数据库存值
						if(data.result_info == "[]"){//数据字典中，当前工艺为null：则直接初始化
							$("#shirt_technics").trigger("chosen:updated"); 
						}else{
							if(falg){
								$("#shirt_technics").val(CraftworkPriceDate.shirt_technics)//设置值  
							}
							$("#shirt_technics").trigger("chosen:updated"); 
						}
				} else if (data.result_code == "N") {
					window.parent.bootbox.dialog({
						title : "错误信息",
						message : "数据加载失败！" + "<br><br>" + data.result_info,
						size : "middle",
						buttons : {
							cancelType : {
								label : "确定",
								className : "btn-default",
								callback : function() {
									return true;
								}
							}
						}
					});
				}
			}
		});
	};	
	
	//初始化 是否默认衬工艺
	function initTypeList() {
		var url = path + "api/common/list/getSingleDataDictItemList";
		url += "?typeCode=yes_or_no&enabledFlag=Y";
		$.ajax({
			type : "get",
			url : url,
			headers:{"token":securityContext.token},
			success : function(data) {
				if (data.result_code == "Y") {
					$("#is_def_shirt_technics").html("")
					$.each(JSON.parse(data.result_info), function(index, d) {
	               	var option='<option value="' + d.item_code + '">'+ d.item_name + '</option>';
	               	$("#is_def_shirt_technics").append(option);  
				});
					$("#is_def_shirt_technics").chosen({disable_search:'false'});
					$("#is_def_shirt_technics").val(CraftworkPriceDate.is_def_shirt_technics)//设置值  
					$("#is_def_shirt_technics").trigger('chosen:updated');//更新选项  
				} else if (data.result_code == "N") {
					window.parent.bootbox.dialog({
						title : "错误信息",
						message : "数据加载失败！" + "<br><br>" + data.result_info,
						size : "middle",
						buttons : {
							cancelType : {
								label : "确定",
								className : "btn-default",
								callback : function() {
									return true;
								}
							}
						}
					});
				}
			}
		});
	};
	
	function totalPracticalPrice(obj){
		if(obj){
		obj.value = obj.value.replace(/[^\d.]/g,""); // 清除"数字"和"."以外的字符
		obj.value = obj.value.replace(/^\./g,""); // 验证第一个字符是数字
		obj.value = obj.value.replace(/\.{2,}/g,"."); // 只保留第一个, 清除多余的
		obj.value = obj.value.replace(".","$#$").replace(/\./g,"").replace("$#$",".");
		//obj.value = obj.value.replace(/^(\-)*(\d+)\.(\d\d).*$/,'$1$2.$3'); // 只能输入两个小数
		}
	}
</script>