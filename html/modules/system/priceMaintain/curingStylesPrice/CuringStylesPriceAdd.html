<script type="text/javascript">
       if(sessionStorage.getItem('securityContext')==null){
         window.location.href="/APPLETPC/login.html";
        }
        var securityContext = JSON.parse(sessionStorage.getItem('securityContext'));

        var path = sessionStorage.getItem('path');
</script>
<!DOCTYPE html>
<html>
<head>
	<title>新建零售定价</title>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	<link type="text/css" rel="stylesheet" href="/APPLETPC/css/common/common.css">
    <link type="text/css" rel="stylesheet" href="/APPLETPC/js/bootstrap/css/bootstrap.css">
	<link type="text/css" rel="stylesheet" href="/APPLETPC/js/plugins/bootstrap-datetime/css/bootstrap-datetimepicker.min.css">
	<link type="text/css" rel="stylesheet" href="/APPLETPC/js/plugins/bootstrap-datetime/css/bootstrap-datetimepicker.min.css">
	<script type="text/javascript"src="/APPLETPC/js/jquery/jquery-2.2.3.min.js"></script>
	<script type="text/javascript" src="/APPLETPC/js/common/common.js"></script>
	<script type="text/javascript" src="/APPLETPC/js/common/util.js"></script>
    <script type="text/javascript" src="/APPLETPC/js/json/json2.js"></script>
	<script type="text/javascript" src="/APPLETPC/js/plugins/bootstrap-datetime/js/bootstrap-datetimepicker.min.js"></script>
    <script type="text/javascript" src="/APPLETPC/js/bootstrap/js/bootstrap.js"></script>
	<script type='text/javascript' src='/APPLETPC/js/json/model/SysLog.js'></script>
	<script type="text/javascript" src="../../../../../js/json/model/SysCuringStylesPrice.js"></script>
	<script type="text/javascript" src="/APPLETPC/js/plugins/bootstrap-datetime/js/locales/bootstrap-datetimepicker.zh-CN.js"></script>
	<script type="text/javascript" src="/APPLETPC/js/plugins/jquery-validate/jquery.validate.min.js"></script>
	<script type="text/javascript" src="/APPLETPC/js/plugins/jquery-validate/jquery.validate.plu.js"></script>
	<script type="text/javascript" src="/APPLETPC/js/plugins/bootstrap-datetime/js/bootstrap-datetimepicker.min.js"></script>
	<script type="text/javascript" src="/APPLETPC/js/plugins/bootstrap-datetime/js/locales/bootstrap-datetimepicker.zh-CN.js"></script>
	<link rel="stylesheet" href="../../../../../js/plugins/jquery-chosen/css/chosen.css" type="text/css"></link>
	<script type="text/javascript" src="../../../../../js/plugins/jquery-chosen/js/chosen.jquery.js"></script>
	<script type="text/javascript" src="../../../../../js/plugins/layer/layer.js"></script>
	

</head>
<style>

</style>
<body class="my-body-content">
	<div  style="margin:0 auto;text-align: center;">
			<form id="typeAddForm" name="typeAddForm" class="my-form-content" >
				<table class="my-form-table-content">
					<tr>
						<td class="my-form-table-td-label">
							<label class="control-label" style="margin:5px;padding:0px;">定价规范</label>
						</td>
						<td class="my-form-table-td-content" style="width:100px">
							<select id="price_specification" name="price_specification" class="dept_select dimension_coding" style="width:180px;padding:5px;float:left;"></select> 
						</td>
					</tr>
					<tr>
						<td class="my-form-table-td-label">
							<label class="control-label" style="margin:5px;padding:0px;">品类</label>
						</td>
						<td class="my-form-table-td-content">
							<select id="category" name="category" class="dept_select dimension_coding"  style="width:180px;padding:5px;float:left;" onchange="changedCategroy()"></select> 
							
						</td>
					</tr>
					<tr>
						<td class="my-form-table-td-label">
							<label class="control-label" style="margin:5px;padding:0px;" >衬工艺</label>
						</td>
						<td class="my-form-table-td-content">
							<select id="shirt_technics" name="shirt_technics" class="dept_select dimension_coding" style="width:180px;padding:5px;float:left;"></select> 
						</td>
					</tr>
					<tr>
						<td class="my-form-table-td-label">
							<label class="control-label" style="margin:5px;padding:0px;">是否默认衬工艺</label>
						</td>
						<td class="my-form-table-td-content">
							<select id="attribute1" name="attribute1" class="dept_select dimension_coding" style="width:180px;padding:5px;float:left;"></select> 
						</td>
					</tr>
					<tr>
						<td class="my-form-table-td-label">
							<label class="control-label" style="margin:5px;padding:0px;">面料价格区间</label>
						</td>
						<td class="my-form-table-td-content" style="width:180px;padding:0px;float:left;">
							<nobr>
								<input id="fabric_price_range" name="fabric_price_range"  type="text"  onkeyup="totalPracticalPrice(this)"  min="0" required="required" class="form-control input-sm" style="width:80px;padding:5px;float:left;margin-right: 2px;">
								<span>---</span>
								<input id="fabric_price_range2" name="fabric_price_range2"  type="text"  onkeyup="totalPracticalPrice(this)"   min="0" required="required"class="form-control input-sm" style="width:80px;padding:5px;float:right;">
							</nobr>
						</td>
					</tr>
					<tr>
						<td class="my-form-table-td-label">
							<label class="control-label" style="margin:5px;padding:0px;">款式号</label>
						</td>
						<td class="my-form-table-td-content">
							<select id="style_code" name="style_code" class="dept_select dimension_coding" style="width:180px;padding:5px;float:left;"></select> 
						</td>
					</tr>
					<tr>
						<td class="my-form-table-td-label">
							<label class="control-label" style="margin:5px;padding:0px;" >零售价</label>
						</td>	
						<td class="my-form-table-td-content">
							<input  id="retail_price" name="retail_price" type="text"  onkeyup="totalPracticalPrice(this)"   min="0" required="required" class="form-control input-sm"  style="width:180px;padding:5px;float:left;"></select> 
						</td>
					</tr>
				</table>
			</form>
	</div>
</body>
</html>
<script type="text/javascript">

$(document).ready(function() {
	initCategoryList();					//初始化品类 下拉选
	initPriceSpecificationList();		//初始化定价规范 下拉选
	initTypeList();						//初始化是否默认衬工艺  下拉选
	
});
function changedCategroy(){
	initTechnologyList();//初始化衬工艺
	getStyleCodeByProductCode();//初始化款式号
}

function initAdd(){
	var result = false;
	var addFalg = true;
	
	if(!$("#fabric_price_range")[0].validity.valid){
		layer.msg("【面料价格区间】不能为空")
		$("#fabric_price_range").focus();
		return false;
	}else if(!$("#fabric_price_range2")[0].validity.valid){
		layer.msg("【面料价格区间】不能为空")
 		$("#fabric_price_range2").focus();
		return false;
	}else if(!$("#retail_price")[0].validity.valid){
		layer.msg("【零售价】不能为空")
		$("#retail_price").focus();
		return false;
	}else if(parseFloat($("#fabric_price_range2")[0].value) <= parseFloat($("#fabric_price_range")[0].value)){
		layer.msg("【面料价格区间】格式错误")
		$("#fabric_price_range2").focus();
		return false;
	}
 	
	
	var cc = new SysCuringStylesPrice();
	var addFalg=false;
	dwr.util.getValues(cc);
	//查询 面料号 ：定价规范+每个价格区间+每个品类：只能有一个默认衬工艺项	
	var queryIsDefaultUrl = path+"api/sys/curingStylesPrice/getListPrice";
	if(cc.attribute1 == "yes"){
		 $.ajax({
				type : "get",
				url : queryIsDefaultUrl,
				async:false,
				data:{"token":securityContext.token,"price_specification":cc.price_specification,"category":cc.category,"shirt_technics":cc.shirt_technics,"fabric_price_range":cc.fabric_price_range,"fabric_price_range2":cc.fabric_price_range2,"id":"null","style_code":cc.style_code},
				success : function(data) {
					if (data.result_info== "") {
						addFalg=true;
					}else{
						addFalg=false;
						layer.msg("已有默认衬工艺项")
						$("#is_def_shirt_technics").focus();
					}
				}
			}); 
	}else{
		addFalg=true;
	}
	if(addFalg){
		result=doAddCraftworkPrice();
	}else{
		return false;
	}
	return result;
	
}


function doAddCraftworkPrice() {
		
		var result = false ;
		var cc = new SysCuringStylesPrice();
		dwr.util.getValues(cc);
		cc.last_updated_by=securityContext.user_id;
		cc.created_by=securityContext.user_id;
		var url =path+"api/sys/curingStylesPrice/add";
		url += "?t=" + new Date();
		url+="&token="+securityContext.token;
		
		$.ajax({
			type:"POST",
			url:url,
			contentType: 'application/json',
		 	data:JSON.stringify(cc),
			async:false,
			success: function(data) {
					if (data.result_code == "Y") {
					recordLog("O","APPLETPC","新增工艺价格成功",securityContext.user_id);
					 result = true;
						window.top.bootbox.dialog({
							title: "提示信息",
							message: "保存成功！",
							size: "middle",
							buttons: {
								cancelType: {
						      		label: "确定",
						      		className: "btn-success",
						      		callback: function() {
						      			return true;
						      		}
								}
							}
						});
	        
					} else if (data.result_code == "N") {
					recordLog("OF","APPLETPC","新增工艺价格失败",securityContext.user_id);
						result = false;
						window.top.bootbox.dialog({
							title: "错误信息",
							message: "保存失败！" + "<br><br>" + json.result_info,
							size: "middle",
							buttons: {
								cancelType: {
						      		label: "确定",
						      		className: "btn-success",
						      		callback: function() {
						      			return true;
						      		}
								}
							}
						});
					}
			    }
			});
		return result;
	
}

		//1 初始化定价规范
		function initPriceSpecificationList() {
			var url = path + "api/sys/price/getPriceSpecification";
			$.ajax({
				type : "get",
				url : url,
				headers:{"token":securityContext.token},
				success : function(data) {
					if (data.result_code == "Y") {
						$("#price_specification").html("");
						$.each(JSON.parse(data.result_info), function(index, d) {
		                   var option='<option value="' + d.code + '">'+ d.name + '</option>';
		                   category+=option
						$("#price_specification").append(option);  
						});
						$("#price_specification").chosen();
					} else if (data.result_code == "N") {
						window.parent.bootbox.dialog({
							title : "错误信息",
							message : "数据加载失败！" + "<br><br>" + data.result_info,
							size : "middle",
							buttons : {
								cancelType : {
									label : "确定",
									className : "btn-default",
									callback : function() {
										return true;
									}
								}
							}
						});
					}
				}
			});
		};	
	
	
		//2 初始化 品类
		function initCategoryList() {
			var url = path + "api/collectMoney/getFixedStyleSelect";
			$.ajax({
				type : "POST",
				url : url,
				headers:{"token":securityContext.token},
				success : function(data) {
					if (data.result_code == "Y") {
						$("#category").html("");
						$.each(JSON.parse(data.result_info), function(index, d) {
	                       var option='<option value="' + d.code + '">'+ d.name + '</option>';
	                       category+=option
						$("#category").append(option);  
						});
						$('#category').chosen();
						$("#shirt_technics").chosen({placeholder_text_single:'该品类无衬工艺项'});
						$("#style_code").chosen({placeholder_text_single:'该品类无款式号'});
						initTechnologyList();//初始衬工艺 下拉选
						getStyleCodeByProductCode();//初始化款式号
						
					} else if (data.result_code == "N") {
						window.parent.bootbox.dialog({
							title : "错误信息",
							message : "数据加载失败！" + "<br><br>" + data.result_info,
							size : "middle",
							buttons : {
								cancelType : {
									label : "确定",
									className : "btn-default",
									callback : function() {
										return true;
									}
								}
							}
						});
					}
				}
			});
		};
	
	
		
		// 初始衬工艺 下拉选
		function initTechnologyList() {
			var url = path + "api/collectMoney/getTechnologySelect";
			$.ajax({
				type : "POST",
				url : url,
				data:{"token":securityContext.token,code:$("#category").val()},
				success : function(data) {
					var tempData=JSON.parse(data.result_info);
					if($("#category").val()=='3000' || $("#category").val()=='11000'){
						tempData.push({code: "", name: "机器工艺"});
					}
					if (data.result_code == "Y") {
							$("#shirt_technics").html("")
							$.each(tempData, function(index, d) {
	                       	var option='<option value="' + d.code + '">'+ d.name + '</option>';
	                       	$("#shirt_technics").append(option);  
						});
						if($("#category").val()=='3000' || $("#category").val()=='11000'){
							$("#shirt_technics").val("")//设置值  
						}
						$("#shirt_technics").trigger("chosen:updated"); 
					} else if (data.result_code == "N") {
						window.parent.bootbox.dialog({
							title : "错误信息",
							message : "数据加载失败！" + "<br><br>" + data.result_info,
							size : "middle",
							buttons : {
								cancelType : {
									label : "确定",
									className : "btn-default",
									callback : function() {
										return true;
									}
								}
							}
						});
					}
				}
			});
		};	
		//初始化款式号
		function getStyleCodeByProductCode() {
			var url = path + "api/collectMoney/getStyleCodeByProductCode";
			$.ajax({
				type : "POST",
				url : url,
				data:{"token":securityContext.token,code:$("#category").val()},
				success : function(data) {
					if (data.result_code == "Y") {
						$("#style_code").html("")
						$.each(JSON.parse(data.result_info), function(index, d) {
                       	var option='<option value="' + d.code + '">'+ d.name + '</option>';
                       	$("#style_code").append(option);  
					});
						$("#style_code").trigger("chosen:updated"); 
					} else if (data.result_code == "N") {
						window.parent.bootbox.dialog({
							title : "错误信息",
							message : "数据加载失败！" + "<br><br>" + data.result_info,
							size : "middle",
							buttons : {
								cancelType : {
									label : "确定",
									className : "btn-default",
									callback : function() {
										return true;
									}
								}
							}
						});
					}
				}
			});
		};
		//初始化 是否默认衬工艺
		function initTypeList() {
			var url = path + "api/common/list/getSingleDataDictItemList";
			url += "?typeCode=yes_or_no&enabledFlag=Y";
			$.ajax({
				type : "get",
				url : url,
				headers:{"token":securityContext.token},
				success : function(data) {
					if (data.result_code == "Y") {
						$("#attribute1").html("")
						$.each(JSON.parse(data.result_info), function(index, d) {
                       	var option='<option value="' + d.item_code + '">'+ d.item_name + '</option>';
                       	$("#attribute1").append(option);  
					});
						$("#attribute1").chosen({disable_search:'false'});
					} else if (data.result_code == "N") {
						window.parent.bootbox.dialog({
							title : "错误信息",
							message : "数据加载失败！" + "<br><br>" + data.result_info,
							size : "middle",
							buttons : {
								cancelType : {
									label : "确定",
									className : "btn-default",
									callback : function() {
										return true;
									}
								}
							}
						});
					}
				}
			});
		};	
	
		function totalPracticalPrice(obj){
			if(obj){
			obj.value = obj.value.replace(/[^\d.]/g,""); // 清除"数字"和"."以外的字符
			obj.value = obj.value.replace(/^\./g,""); // 验证第一个字符是数字
			obj.value = obj.value.replace(/\.{2,}/g,"."); // 只保留第一个, 清除多余的
			obj.value = obj.value.replace(".","$#$").replace(/\./g,"").replace("$#$",".");
			//obj.value = obj.value.replace(/^(\-)*(\d+)\.(\d\d).*$/,'$1$2.$3'); // 只能输入两个小数
			}
		}
</script>